# 持续集成(continuous integration)
### 概念
&emsp;&emsp;持续集成，简单的说就是频繁的（一天多次）将代码集成到主干。  
&emsp;&emsp;一次CI构建的过程可能包含编译、测试、审查、和部署以及其他一些事情

### 业界术语

**自动化（automated）**： 一个”无须干预”的过程。当一个完全自动化的过程开始之后，不需要用户的干预。  
**构建（build）**：生成、测试、审查和部署软件的一组活动。  
**持续（continuous）**：从技术上说，持续意味着一旦开始就永不结束。这意味着构建会不断进行，但实际上并非如此。CI中的持续更像是坚持，一个进程不断运行，等待版本控制库的变更。  
**集成（integration）**：将各部分源代码结合到一起，确定它们是否能作为一个整体工作。  
**持续集成（Continuous Integration）**：一项软件开发实践，其中团队的成员经常集成他们的工作，通常每人每天至少集成一次——这导致每天集成多次。每次集成是通过自动化的构建（包括测试）进行的，目的是尽快的检查集成错误。  
**审查（inspection）**：出于内部品质要求，对源代码/字节码进行分析。在本书中，我们将自动化的审查（静态分析和运行时刻分析）成为”软件审查“。  
**私有/系统构建（private/system build）**：将变更提交到版本控制库之前，在本地执行本地构建，目的是减少最近的变更破坏集成构建的可能性。  
**发布构建（release build）**：准备将软件发布给用户。这可能发生在一次迭代结束时或达到某个里程碑时，必须包括验收测试，可能还包括大量的性能测试和负载测试。  

### CI的目的
&emsp;&emsp;持续集成的目的，就是让产品可以快速迭代，同时保持较高的代码质量。达成这个目的的核心策略就是，每次代码集成到主干之前，必须经过自动化测试。只要有一个测试用例有问题，就不能集成。

### 典型CI步骤
<img src="attachment/images/CI/持续集成1.png" width="800" heigh="400" alt = "持续集成1" align = center/>

1. 首先，一名开发者向版本控制库提交代码。同时，集成构建服务器上的CI服务正在主动检测版本库中的变更，或等待外部触发
2. 在提交发生之后，CI流程被触发，CI服务器会从库中取得最新的代码副本，执行构建脚本（执行相应的编译，测试工作）
3. CI服务器向指定的项目成员发出电子邮件，提供构建结果的反馈
4. 项目成员根据报告决定下一步工作，CI服务器等待下一次的触发

### CI的关键功能点
* 与版本控制系统的连接
* 构建脚本
* 某种类型的反馈机制（如电子邮件）
* 集成代码变更的过程（手工或CI服务器）

### CI的价值  
>   &emsp;&emsp;持续集成并不能消除Bug，而是让它们非常容易发现和改正。

* 减少风险  
> &emsp;&emsp;较为频繁的进行集成并执行测试和代码审查，将代码缺陷发现的时间点前移,而不必等到最后的提测阶段。
* 防止分支大幅偏离主干
> &emsp;&emsp;如果不是经常集成，主干又在不断更新，会导致最终的集成难度变大。
* 减少重复过程  
> &emsp;&emsp;在项目中重复过程，包括代码编译、数据库集成、测试、代码审查、部署、反馈等，通过CI，可以是这些过程每次都以相同的方式有序执行。
    
* 在任何时间/任何地点生成可部署的软件
> &emsp;&emsp;CI实践，保证了代码中的每次改动，都经过充分的测试，基准代码库中的项目随时可以部署到生产环境中。
* 增强项目的可见性
> &emsp;&emsp;采用CI实践，可以自动收集代码质量、测试覆盖率、构建成功率等项目相关信息。

### 我们的持续集成

目前公司的持续集成使用 gitlab + jenkins + postman + sonarqube 实现： 
1. gitlab：一个用于仓库管理系统的开源项目，使用Git作为代码管理工具；
2. jenkins：是基于Java开发的一种持续集成工具，使用jenkins整合CI流程中的各个环节；
3. postman：功能强大的网页测试工具；
4. sonarqube：一个用于代码质量管理的开源平台，用于公司各项目的静态代码检测。

#### 一次完整的集成过程 

<img src="attachment/images/CI/持续集成3.png" width = "800" heigh = "400" alt = "持续集成3" align = center />

1. 开发人员完成初步开发工作后，提交到指定分支  
<img src="attachment/images/CI/完整集成1.png" width = "800" heigh = "400" alt = "完整集成1" align = center />
2. gitlab中配置好的webhooks触发jenkins构建
<img src="attachment/images/CI/完整构建2.png" width = "800" heigh = "400" alt = "完整构建2" align = center />
3. jenkins 按预设脚本，执行构建过程中的每一步（初始环境检查/代码拉取/静态代码检测/接口测试）
    > 其中的静态代码检测由sonarqube完成，接口测试由postman完成  
   
    执行持续集成中的分解操作，任何一个环节失败，构建都返回失败
    <img src="attachment/images/CI/完整构建3.png" width = "800" heigh = "400" alt = "完整构建3" align = center />  

    执行postman录制的测试脚本，生成相关的测试报告
    <img src="attachment/images/CI/完整构建4.png" width = "800" heigh = "400" alt = "完整构建4" align = center />  

    使用sonarqube对项目代码进行静态代码检测
    <img src="attachment/images/CI/完整构建5.png" width = "800" heigh = "400" alt = "完整构建5" align = center />  

4. 发送构建结果给相关成员
<img src="attachment/images/CI/完整构建6.png" width = "800" heigh = "400" alt = "完整构建6" align = center />


